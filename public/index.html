<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Füne</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="./bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="favicon.png" />
    <script src="https://unpkg.com/vue@next"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
    <div id="app" class="container">
        <h1><img src="./favicon.png" class="align-baseline"><span class="align-baseline">Füne</span></h1>

        <div class="mb-3 rounded border border-4 p-3">
            <h4>Currency</h4>
            <form>
                <div class="input-group mb-3">
                    <label class="input-group-text" for="currencyCelerity">Celerity</label>
                    <input id="currencyCelerity" v-model="currency.c" type="text" class="form-control text-right" disabled>
                </div>
                <div class="input-group mb-3">
                    <label class="input-group-text" for="currencyStepTime">Day duration</label>
                    <input id="currencyStepTime" v-model="currency.stepTime" type="text" class="form-control text-right" disabled>
                    <span class="input-group-text">seconds</span>
                </div>
                <div class="input-group mb-3">
                    <label class="input-group-text" for="currencyRevaluationTime">Revaluation period</label>
                    <input id="currencyRevaluationTime" v-model="currency.revaluationTime" type="text" class="form-control text-right" disabled>
                    <span class="input-group-text">days</span>
                </div>
                <div class="input-group mb-3">
                    <label class="input-group-text" for="currencyElapsedTime">Elapsed time</label>
                    <input id="currencyElapsedTime" v-model="currency.elapsedTime" type="text" class="form-control text-right" disabled>
                    <span class="input-group-text">days</span>
                </div>
            </form>    
        </div>    


        <div class="mb-3 rounded border border-4 p-3">
            <h4>Transaction</h4>
            <form class="row g-4 align-items-center">
                <div class="col-auto">
                    <div class="input-group">
                        <label class="input-group-text" for="txFrom">From </label>
                        <select v-model="tx.from" id="txFrom" class="form-select">
                            <option disabled value="">Select one</option>
                            <option v-for="account in accounts" :value="account.name">{{ account.name }}</option>
                        </select>
                    </div>
                </div>
                <div class="col-auto">
                    <div class="input-group">
                        <label class="input-group-text" for="txTo">To </label>
                        <select v-model="tx.to" id="txTo" class="form-select">
                            <option disabled value="">Select one</option>
                            <option v-for="account in accounts" :value="account.name">{{ account.name }}</option>
                        </select>
                    </div>
                </div>
                <div class="col-auto">
                    <div class="input-group">
                        <input v-model="tx.value" type="number" class="form-control text-right">
                        <span class="input-group-text">Ü</span>
                    </div>
                </div>
                <div class="col-auto">
                    <button type="button" class="btn btn-primary" @click="executeTx()">Pay</button>
                </div>
            </form>
        </div>


        <div class="mb-3 rounded border border-4 p-3">
            <h4>New Account</h4>
            <form class="row g-3 align-items-center">
                <div class="col-auto">
                    <div class="input-group">
                        <label for="accountName" class="input-group-text">Name</label>
                        <input v-model="newAccount.name" type="text" class="form-control" id="accountName" />
                    </div>
                </div>
                <div class="col-auto">
                    <div class="input-group">
                        <div class="input-group-text">
                            <input v-model="newAccount.creator" type="checkbox" class="mt-0" id="accountCreator">
                        </div>
                        <label class="input-group-text" for="accountCreator">
                            <span v-if="newAccount.creator" class="badge bg-primary text-light" style="width: 80px;">Creator</span>
                            <span v-else class="badge bg-secondary text-light" style="width: 80px;">Wallet</span>
                        </label>
                    </div>
                </div>
                <div class="col-auto">
                    <button type="button" class="btn btn-primary" @click="createAccount()">Create</button>
                </div>
            </form>
        </div>

        <table class="table">
            <thead class="table-light">
                <tr>
                    <th>Name</th>
                    <th class="text-center">Role</th>
                    <th class="text-right">Balance</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="account in accounts">
                    <td>{{ account.name }}</td>
                    <td class="text-center">
                        <span v-if="account.creator" class="badge bg-primary text-light">Creator</span>
                        <span v-else class="badge bg-secondary text-light">Wallet</span>
                    </td>
                    <td class="text-right">{{ currencyDecimal(account.balance) }} Ü</td>
                    <td class="text-right"><a href="#" @click="deleteAccount(account.name)">Delete</a></td>
                </tr>
            </tbody>
        </table>
    </div>

</body>

<script>
    const app = {
        data() {
            return {
                newAccount: {name: '', creator: true},
                accounts: [],
                tx: {from: '', to: '', value: 0},
                currency: {
                    date: new Date().toISOString(),
                    c: 0,
                    stepTime: 0,
                    elapsedTime: 0,
                    revaluationTime: 0, 
                    playing: false,
                }
            }
        },
        methods: {
            currencyDecimal(value) {
                return (value/100).toFixed(2)
            },
            executeTx() {
                axios
                    .post('/tx', {from: this.tx.from, to: this.tx.to, value: parseInt(this.tx.value) * 100})
                    .then(response => {
                        this.listAccounts()
                    })
            },
            getCurrency() {
                axios
                    .get('/currency')
                    .then(response => {
                        this.currency = response.data
                    })
            },
            listAccounts() {
                axios
                    .get('/accounts')
                    .then(response => {
                        this.accounts = response.data
                    })
            },
            createAccount() {
                axios
                    .post('/accounts', this.newAccount)
                    .then(response => {
                        this.listAccounts()
                    })
            },
            deleteAccount(name) {
                if (confirm("Are you sure to delete " + name + "?"))
                    axios
                        .delete('/accounts/' + name)
                        .then(response => {
                            this.listAccounts()
                        })
            },
            refresh() {
                this.listAccounts()
                this.getCurrency()
            }
        },
        mounted() {
            this.refresh();
            setInterval(this.refresh, 60000)
        }
    }


    Vue.createApp(app).mount('#app')

</script>


</html>